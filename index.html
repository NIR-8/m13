<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>NIR8 ‚Äî Calculators + Chat</title>
<style>
  /* ========= Global from index/index-1 (merged & simplified) ========= */
  :root{--bar:#075e54;--muted:#666;--bg1:#4facfe;--bg2:#00f2fe;--menu-bg:rgba(0,0,0,.85);--accent:#28a745}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Poppins}
  body{margin:0;background:linear-gradient(to right,var(--bg1),var(--bg2));min-height:100vh;padding-top:72px}
  .menu-bar{position:fixed;top:0;left:0;right:0;background:var(--menu-bg);color:#fff;z-index:1000;padding:10px 12px}
  .menu-container{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:12px}
  .menu-item{padding:6px 10px;cursor:pointer;color:#fff}
  .menu-item.active{background:#19692f;border-radius:6px}
  .menu-controls{margin-left:auto;display:flex;gap:10px;align-items:center}
  .container{padding:110px 16px 80px;max-width:1100px;margin:0 auto}
  .calculator{background:#fff;border-radius:10px;padding:16px;margin-bottom:18px;box-shadow:0 6px 18px rgba(0,0,0,.12)}
  .hidden{display:none!important}
  .acb-input{width:96px;padding:6px;border:1px solid #ddd;border-radius:6px}
  .acb-span{display:block;padding:6px}
  footer{position:fixed;left:0;right:0;bottom:0;background:var(--menu-bg);color:#fff;text-align:center;padding:8px;font-size:14px}
  /* Chat button */
  .chat-fab{position:fixed;right:18px;bottom:18px;width:60px;height:60px;border-radius:50%;background:#25d366;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 8px 24px rgba(0,0,0,.2);cursor:pointer;z-index:20000}
  .chat-fab:hover{transform:translateY(-3px);transition:transform .12s}
  /* Chat small badge */
  .chat-badge{position:absolute;top:6px;right:6px;background:#ff3b30;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px}
  /* Responsive */
  @media(max-width:820px){ .menu-container{flex-wrap:wrap} .acb-input{width:80px} .chat-fab{right:12px;bottom:12px;width:56px;height:56px} }
  /* Minimal styling for chat view inside same page (used in popup/tab) */
  .chat-wrapper{display:flex;flex-direction:column;height:100vh}
  .chat-header{background:var(--bar);color:#fff;padding:12px;display:flex;align-items:center;justify-content:space-between}
  .messages{flex:1;overflow:auto;padding:12px;background:linear-gradient(#fff,#fbfdff);display:flex;flex-direction:column;gap:8px}
  .msg{max-width:70%;padding:8px;border-radius:10px;word-break:break-word}
  .msg.me{align-self:flex-end;background:#dcf8c6;border:1px solid #cfeccd}
  .msg.other{align-self:flex-start;background:#f1f3f4;border:1px solid #e6e7e8}
  .composer{display:flex;gap:8px;padding:10px;border-top:1px solid #eee;background:#fff}
  input[type=text],input[type=password],textarea{padding:8px;border:1px solid #ddd;border-radius:6px}
  button{padding:8px 10px;border-radius:6px;border:0;cursor:pointer;background:var(--bar);color:#fff}
  .small{background:#333;padding:6px 8px}
  .danger{background:#e74c3c}
  .muted{color:var(--muted);font-size:13px}
  /* Startup overlay */
  #startupOverlay{position:fixed;inset:0;background:linear-gradient(to right,var(--bg1),var(--bg2));z-index:2000;display:flex;align-items:center;justify-content:center}
  .startup-panel{width:100%;max-width:920px;background:#fff;padding:22px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.2)}
  .curtain-up{transform:translateY(-120%);transition:transform .52s cubic-bezier(.2,.9,.3,1)}
</style>
</head>
<body>

<!-- Top menu merged from index-1 layout (menu controls, std qty etc) -->
<div class="menu-bar" role="navigation" aria-label="Top menu">
  <div class="menu-container">
    <div style="display:flex;gap:8px;align-items:center">
      <div class="menu-item active" id="menuFormula">Formula Calculator</div>
      <div class="menu-item" id="menuAcb">(A + C) - B Calculator</div>
    </div>
    <div class="menu-controls" role="region" aria-label="Controls">
      <div>
        <label for="stdQty" style="display:block;font-size:12px;color:#ddd">Std Qty (A) ‚Äî per lot</label>
        <input id="stdQty" type="number" step="0.001" min="0" placeholder="e.g. 417.000" style="padding:6px;border-radius:6px;width:110px">
      </div>
      <div>
        <label style="display:block;font-size:12px;color:#ddd">Lots</label>
        <select id="numLots" style="padding:6px;border-radius:6px">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
        </select>
      </div>
      <div>
        <label style="display:block;font-size:12px;color:#ddd">Total Std C (kg)</label>
        <input id="totalC" type="number" step="0.001" min="0" placeholder="Total C" style="padding:6px;border-radius:6px;width:110px">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button id="distributeBtn" style="margin-left:6px">Distribute C</button>
      </div>
    </div>
  </div>
</div>

<!-- Startup overlay from index-1 (keeps user required setup) -->
<div id="startupOverlay" role="dialog" aria-modal="true">
  <div class="startup-panel" id="startupPanel">
    <h2 style="margin:0 0 8px 0">Setup</h2>
    <p style="margin:0 0 12px 0;color:#333">Enter <strong>Std Qty (A)</strong> (per lot), choose number of lots and enter <strong>Total Std C</strong>. Click <strong>Distribute C</strong> or press Enter in the Std Qty field to continue.</p>

    <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:160px">
        <label for="startupStdQty">Std Qty (A) ‚Äî per lot</label>
        <input id="startupStdQty" type="number" step="0.001" min="0" placeholder="e.g. 417.000">
      </div>

      <div style="min-width:100px">
        <label for="startupNumLots">Lots</label>
        <select id="startupNumLots">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
        </select>
      </div>

      <div style="flex:1;min-width:160px">
        <label for="startupTotalC">Total Std C (kg)</label>
        <input id="startupTotalC" type="number" step="0.001" min="0" placeholder="e.g. 337.500">
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;margin-top:16px">
      <button id="startupDistribute">Distribute C</button>
    </div>

    <p style="margin-top:12px;color:#666;font-size:13px">You can change these values any time in the top menu ‚Äî all fields remain editable.</p>
  </div>
</div>

<main class="container" id="appMain">
  <!-- Formula Calculator (merged) -->
  <section id="formulaCalculator" class="calculator" role="region" aria-label="Formula calculator">
    <h3 style="margin-top:0">Formula Calculator</h3>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:150px">
        <label for="Q">Quantity (Q)</label>
        <input id="Q" type="number" step="0.001" placeholder="Enter Q">
      </div>
      <div style="min-width:150px">
        <label for="water">Water (W)</label>
        <input id="water" type="number" step="0.01" placeholder="W (%)">
      </div>
      <div style="min-width:150px">
        <label for="assay">Assay (A)</label>
        <input id="assay" type="number" step="0.01" placeholder="A (%)">
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="calcF1">Calculate F1</button>
      <button id="calcF2">Calculate F2</button>
      <button id="calcF3">Calculate F3</button>
    </div>
  </section>

  <!-- A + C - B calculator merged (index-1 style) -->
  <section id="acbCalculator" class="calculator hidden" role="region" aria-label="A C B calculator">
    <h3 style="margin-top:0">(A + C) - B Calculator</h3>

    <div style="overflow:auto">
      <table id="acbTable" aria-describedby="acbDesc">
        <caption id="acbDesc" class="hidden">Assay-based (A + C) - B calculations</caption>
        <thead>
          <tr id="acbHeaderRow">
            <th>Field</th>
            <!-- lot headers inserted dynamically -->
            <th>Total (kg)</th>
          </tr>
        </thead>
        <tbody>
          <tr id="rowA"><td>A per lot (editable)</td><td id="totalA">-</td></tr>
          <tr id="rowB"><td>Issued Qty B</td><td id="totalB">0.000</td></tr>
          <tr id="rowC"><td>C per lot (distributed, editable)</td><td id="totalCDisplay">0.000</td></tr>
          <tr id="rowResult"><td>(A + C) - B</td><td id="totalResult">0.000</td></tr>
        </tbody>
      </table>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="resetAcb" style="background:#ff6b6b">Reset</button>
      <button id="printAcb" class="small">Print</button>
    </div>
  </section>

  <div id="calculationSteps" class="hidden"></div>
</main>

<footer>Results are reliable but always double-check. NIR8 Tools</footer>

<!-- Floating chat button (opens new window on desktop, fullscreen on mobile) -->
<div title="Open Chat" class="chat-fab" id="chatFab" aria-label="Open chat">
  üí¨
  <div class="chat-badge hidden" id="unreadBadge">0</div>
</div>

<!-- Chat HTML (kept in this file; used when opening ?chat=1) -->
<!-- If the page is loaded with ?chat=1, the script will display the chat-only view (useful for popup/new window). -->
<!-- Chat code is based on your GitHub-backed chat implementation; token removed for security ‚Äî set GITHUB_TOKEN before use. -->
<script>
/* ========= Chat + Storage (merged and improved) =========
   Based on your original chat code and merged features.
   Sources used: index.html (chat code) and index-1.html (calculator and distribution features). 
   See: index.html and index-1.html. Ó®Å2Ó®Ç Ó®Å3Ó®Ç
*/

/* --------- CONFIG: set your GitHub repo here (DO NOT commit token to source control) --------- */
const GITHUB_API = 'https://api.github.com';
const DATA_FILE = 'batch-data.json';
const githubConfig = {
  owner: 'NIR-8',
  repo: 'bms',
  // SECURITY: PLACEHOLDER. Replace with a secure token at runtime (e.g., via environment or devtools).
  // Do NOT hardcode your PAT in production. Example: window.GITHUB_TOKEN = 'ghp_xxx';
  token: '' // <<-- Set this before using GitHub-backed storage (e.g., in browser console: window.GITHUB_TOKEN = '...' then refresh)
};

/* if runtime override available, use it */
if (window.GITHUB_TOKEN) githubConfig.token = window.GITHUB_TOKEN;

/* --------- Helper: GitHub request (with no-cache header to avoid stale results) -------------- */
async function githubApiRequest(path, options = {}) {
  const url = `${GITHUB_API}${path}`;
  const headers = Object.assign({
    'Accept': 'application/vnd.github.v3+json',
    'Content-Type': 'application/json',
    'Cache-Control': 'no-cache'
  }, options.headers || {});

  if (githubConfig.token) headers['Authorization'] = `token ${githubConfig.token}`;

  // Use fetch with explicit cache: 'no-store' to reduce caching issues
  const res = await fetch(url, Object.assign({ cache: 'no-store' }, options, { headers }));
  if (!res.ok) {
    const text = await res.text().catch(()=>'');
    const err = new Error(`GitHub API ${res.status} ${res.statusText} ${text}`);
    err.status = res.status;
    throw err;
  }
  return res.json();
}

/* --------- read / save with safer flow and retries ---------- */
async function readFromGitHub() {
  if (!githubConfig.token) {
    // If token not set, fall back to localStorage to keep chat functional for testing
    const cached = localStorage.getItem('bms_local_data');
    if (cached) return JSON.parse(cached);
    return defaultData();
  }
  try {
    const file = await githubApiRequest(`/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${DATA_FILE}`);
    const content = atob(file.content.replace(/\n/g,'')); // base64
    // cache locally as fallback
    try { localStorage.setItem('bms_local_data', content); } catch(e){}
    return JSON.parse(content);
  } catch (err) {
    if (err.status === 404) {
      const initial = defaultData();
      await saveToGitHub(initial);
      return initial;
    }
    // network or permission error: fall back to localStorage if present
    const cached = localStorage.getItem('bms_local_data');
    if (cached) return JSON.parse(cached);
    throw err;
  }
}

async function saveToGitHub(obj) {
  // if token absent, save to localStorage instead
  if (!githubConfig.token) {
    try { localStorage.setItem('bms_local_data', JSON.stringify(obj, null, 2)); } catch(e){}
    return;
  }
  let sha = null;
  try {
    const existing = await githubApiRequest(`/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${DATA_FILE}`);
    sha = existing.sha;
  } catch(e){ sha = null; }
  const content = btoa(JSON.stringify(obj, null, 2));
  await githubApiRequest(`/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${DATA_FILE}`, {
    method: 'PUT',
    body: JSON.stringify({ message: `Update chat ${new Date().toISOString()}`, content, sha })
  });
}

/* --------- data model & defaults ---------- */
function defaultData(){
  return {
    users: [
      { id:'admin', name:'Administrator', password:'admin123', isAdmin:true, created: new Date().toISOString() },
      { id:'user1', name:'User One', password:'user123', isAdmin:false, created: new Date().toISOString() }
    ],
    messages: [
      { id: 'sys-1', sender:'System', senderId:'system', text:'Welcome to chat', timestamp: new Date().toISOString() }
    ]
  };
}

/* --------- Chat state & DOM (chat-only view) ---------- */
let appData = null;
let currentUser = null;
let editingId = null;
let pendingDelete = null;

/* Helper to create full chat HTML when loaded with ?chat=1 */
function renderChatShell() {
  document.head.insertAdjacentHTML('beforeend', `
    <style>
      body { margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
      .chat-wrapper{display:flex;flex-direction:column;height:100vh}
      .chat-header{background:var(--bar);color:#fff;padding:12px;display:flex;align-items:center;justify-content:space-between}
      .messages{flex:1;overflow:auto;padding:12px;background:linear-gradient(#fff,#fbfdff);display:flex;flex-direction:column;gap:8px}
      .composer{display:flex;gap:8px;padding:10px;border-top:1px solid #eee;background:#fff}
      input[type=text]{flex:1;padding:8px;border-radius:6px;border:1px solid #ddd}
      button{padding:8px 10px;border-radius:6px;border:0;cursor:pointer;background:var(--bar);color:#fff}
    </style>
  `);
  document.body.innerHTML = `
    <div class="chat-wrapper" id="chatRoot">
      <div class="chat-header">
        <div><strong>Simple Chat</strong><span style="margin-left:8px;color:#fff;opacity:.85">Global</span></div>
        <div><button id="closeChatBtn" style="background:#e74c3c;padding:6px 10px;border-radius:6px">Close</button></div>
      </div>
      <div class="messages" id="messages"></div>
      <div class="composer">
        <input id="msgInput" type="text" placeholder="Type message..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>
  `;

  // wire basic chat interactions for popup/tab
  document.getElementById('closeChatBtn').addEventListener('click', ()=> {
    // in popup, close window; if same tab, go back
    if (window.opener || window.open) {
      try { window.close(); } catch(e){}
      // fallback: redirect to main index
      location.href = location.pathname;
    } else {
      location.href = location.pathname;
    }
  });

  // DOM refs for popup
  window.popupMessagesEl = document.getElementById('messages');
  window.popupMsgInput = document.getElementById('msgInput');
  window.popupSendBtn = document.getElementById('sendBtn');

  window.popupSendBtn.addEventListener('click', async ()=> {
    if (!currentUser) { alert('Please login from main app (or set a current user)'); return; }
    const text = window.popupMsgInput.value.trim();
    if (!text) return;
    const m = { id: uid(), sender: currentUser.name || currentUser.id, senderId: currentUser.id || '', text, timestamp: nowISO() };
    appData.messages.push(m);
    window.popupMsgInput.value = '';
    await saveAndRender(); // writes and refetches to avoid stale state
    // If main window is open and wants to be informed, postMessage
    if (window.opener && !window.opener.closed) {
      try { window.opener.postMessage({ type: 'chat:update' }, '*'); } catch(e){}
    }
  });
}

/* Utilities reused from original chat code */
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8) }
function nowISO(){ return new Date().toISOString() }
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* Render messages into target container (works for both main page and popup) */
function renderMessagesTo(el) {
  const msgs = (appData.messages||[]).slice().sort((a,b)=> new Date(a.timestamp) - new Date(b.timestamp));
  el.innerHTML = '';
  msgs.forEach(m=>{
    const div = document.createElement('div');
    const isOwn = (currentUser && (m.senderId === (currentUser.id||'') || m.sender === (currentUser.name||currentUser.id)));
    div.className = 'msg ' + (isOwn ? 'me' : 'other');
    const time = new Date(m.timestamp).toLocaleString();
    div.innerHTML = `<div style="font-size:12px;color:#666"><strong>${escapeHtml(m.sender)}</strong> <span style="margin-left:8px">${time}${m.editedAt? ' ‚Ä¢ edited':''}</span></div>
      <div style="margin-top:6px">${escapeHtml(m.text)}</div>`;
    el.appendChild(div);
  });
  el.scrollTop = el.scrollHeight;
}

/* save + re-read then render (to ensure latest sha/content) */
async function saveAndRender() {
  try {
    await saveToGitHub(appData);
    appData = await readFromGitHub();
    // render into both main page and popup if available
    const mainMessages = document.getElementById('messages');
    if (mainMessages) renderMessagesTo(mainMessages);
    if (window.popupMessagesEl) renderMessagesTo(window.popupMessagesEl);
    updateUnreadBadge();
  } catch (e) {
    console.error('Save failed', e);
    alert('Save failed: ' + e.message);
  }
}

/* Update unread badge count (simple heuristic: messages since last read stored in sessionStorage) */
function updateUnreadBadge() {
  try {
    const lastSeen = sessionStorage.getItem('chat_last_seen') || 0;
    const unseen = (appData.messages || []).filter(m => new Date(m.timestamp).getTime() > Number(lastSeen)).length - 1; // exclude system
    const badge = document.getElementById('unreadBadge');
    if (!badge) return;
    if (unseen > 0) { badge.textContent = unseen; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
  } catch(e){}
}

/* Main init for chat when main page loaded (non-popup) */
async function initMainChat() {
  try {
    appData = await readFromGitHub();
  } catch(e) {
    console.warn('GitHub read failed, using defaults/local fallback', e);
    appData = defaultData();
  }
  // default to admin not logged in; user must login via main UI (keeps parity with original)
  updateUnreadBadge();
  // periodic refresh to pick up remote changes (every 20s)
  setInterval(async ()=>{
    try {
      const remote = await readFromGitHub();
      // naive diff: if remote messages length differs, update and re-render
      if (remote && remote.messages && appData && (remote.messages.length !== appData.messages.length)) {
        appData = remote;
        const mainMessages = document.getElementById('messages');
        if (mainMessages) renderMessagesTo(mainMessages);
        updateUnreadBadge();
      }
    } catch(e){}
  }, 20000);
}

/* If page opened with ?chat=1 ‚Äî render chat-only view (this is the target for the popup/new window) */
if ((new URLSearchParams(location.search)).get('chat') === '1') {
  (async ()=>{
    // Build chat UI
    renderChatShell();
    try {
      appData = await readFromGitHub();
    } catch(e) { appData = defaultData(); }
    // If currentUser exists in localStorage from main app, use it
    const savedUser = sessionStorage.getItem('chat_current_user');
    if (savedUser) currentUser = JSON.parse(savedUser);
    // render messages
    const rootMessages = document.getElementById('messages');
    renderMessagesTo(rootMessages);
    // wire Enter sending
    document.getElementById('msgInput').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('sendBtn').click(); }
    });
    // periodic refresh
    setInterval(async ()=> {
      try {
        const remote = await readFromGitHub();
        if (remote && remote.messages && remote.messages.length !== appData.messages.length) {
          appData = remote;
          renderMessagesTo(document.getElementById('messages'));
        }
      } catch(e){}
    }, 15000);
  })();
}

/* --------- Message badge click handler is main page: open new window or navigate on mobile ---------- */
document.getElementById('chatFab').addEventListener('click', ()=>{
  // Decide desktop popup vs mobile fullscreen
  const isMobile = /Mobi|Android|iPhone|iPad|Phone/i.test(navigator.userAgent) || window.innerWidth < 720;
  const chatUrl = location.pathname + '?chat=1';
  if (isMobile) {
    // open full-screen in same tab for mobile for best UX
    location.href = chatUrl;
  } else {
    // open popup window centered
    const w = 720, h = 640;
    const left = (screen.width/2)-(w/2);
    const top = (screen.height/2)-(h/2);
    const features = `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=yes`;
    const win = window.open(chatUrl, 'NIR8ChatWindow', features);
    if (!win) {
      alert('Popup blocked ‚Äî please allow popups or open the chat in the same tab.');
      // fallback to same tab
      location.href = chatUrl;
    } else {
      try { win.focus(); } catch(e){}
    }
  }
});

/* Also respond to postMessage updates from popup to refresh main page badge */
window.addEventListener('message', async (ev)=>{
  if (ev.data && ev.data.type === 'chat:update') {
    try { appData = await readFromGitHub(); updateUnreadBadge(); } catch(e){}
  }
});

/* Expose a small public API to set current user (main page login should call this) */
function setCurrentUserForChat(u) {
  currentUser = u;
  try { sessionStorage.setItem('chat_current_user', JSON.stringify(u)); } catch(e){}
  updateUnreadBadge();
}

/* Expose for other scripts */
window.nir8_chat = { setCurrentUserForChat };

/* Init main chat (non-popup) early so badge updates */
initMainChat();

/* ========= End Chat block ========= */
</script>

<!-- ========= Calculator: logic merged from index-1 (distribute, build lots, recalc) ========= -->
<script>
/* The calculator code is taken from index-1 and adapted into this single page merge. See index-1.html. Ó®Å4Ó®Ç */

// formatting helper
function fmt3(v){ const n = Number(v); if (!isFinite(n)) return '0.000'; return (Math.round((n + Number.EPSILON) * 1000) / 1000).toFixed(3); }

// DOM refs
const startupOverlay = document.getElementById('startupOverlay');
const startupStdQty = document.getElementById('startupStdQty');
const startupNumLots = document.getElementById('startupNumLots');
const startupTotalC = document.getElementById('startupTotalC');
const startupDistribute = document.getElementById('startupDistribute');

const stdQty = document.getElementById('stdQty');
const numLots = document.getElementById('numLots');
const totalC = document.getElementById('totalC');
const distributeBtn = document.getElementById('distributeBtn');

const menuFormula = document.getElementById('menuFormula');
const menuAcb = document.getElementById('menuAcb');
const formulaCalculator = document.getElementById('formulaCalculator');
const acbCalculator = document.getElementById('acbCalculator');

const acbHeaderRow = document.getElementById('acbHeaderRow');
const rowA = document.getElementById('rowA');
const rowB = document.getElementById('rowB');
const rowC = document.getElementById('rowC');
const rowResult = document.getElementById('rowResult');

const totalAEl = document.getElementById('totalA');
const totalBEl = document.getElementById('totalB');
const totalCEl = document.getElementById('totalCDisplay');
const totalResultEl = document.getElementById('totalResult');

const resetAcb = document.getElementById('resetAcb');
const printAcb = document.getElementById('printAcb');

let lotElements = []; // {aInput, bInput, cInput, resultCell}

// clear lot columns
function clearLotColumns(){
  while(acbHeaderRow.cells.length > 2) acbHeaderRow.deleteCell(1);
  [rowA, rowB, rowC, rowResult].forEach(r => { while(r.cells.length > 2) r.deleteCell(1); });
  lotElements = [];
}

// build columns for n lots
function buildLots(n){
  clearLotColumns();
  for(let i=0;i<n;i++){
    const th = document.createElement('th'); th.textContent = 'Lot-' + (i+1);
    acbHeaderRow.insertBefore(th, acbHeaderRow.cells[acbHeaderRow.cells.length-1]);

    // A
    const aTd = document.createElement('td');
    const aIn = document.createElement('input'); aIn.type='number'; aIn.step='0.001'; aIn.className='acb-input'; aIn.placeholder='A';
    aIn.addEventListener('input', onLotInputChange); aTd.appendChild(aIn); rowA.insertBefore(aTd, rowA.cells[rowA.cells.length-1];
  }
  // (in some environments the previous line may break; ensure it's correct)
}

// safer buildLots (preventing potential syntax problems above)
function buildLots(n){
  clearLotColumns();
  for(let i=0;i<n;i++){
    const th = document.createElement('th'); th.textContent = 'Lot-' + (i+1);
    acbHeaderRow.insertBefore(th, acbHeaderRow.cells[acbHeaderRow.cells.length-1]);

    const aTd = document.createElement('td');
    const aIn = document.createElement('input'); aIn.type='number'; aIn.step='0.001'; aIn.className='acb-input'; aIn.placeholder='A';
    aIn.addEventListener('input', onLotInputChange); aTd.appendChild(aIn); rowA.insertBefore(aTd, rowA.cells[rowA.cells.length-1]);

    const bTd = document.createElement('td');
    const bIn = document.createElement('input'); bIn.type='number'; bIn.step='0.001'; bIn.className='acb-input'; bIn.placeholder='B';
    bIn.addEventListener('input', onLotInputChange); bTd.appendChild(bIn); rowB.insertBefore(bTd, rowB.cells[rowB.cells.length-1]);

    const cTd = document.createElement('td');
    const cIn = document.createElement('input'); cIn.type='number'; cIn.step='0.001'; cIn.className='acb-input'; cIn.placeholder='C';
    cIn.addEventListener('input', onLotInputChange); cTd.appendChild(cIn); rowC.insertBefore(cTd, rowC.cells[rowC.cells.length-1]);

    const rTd = document.createElement('td'); rTd.textContent='-'; rowResult.insertBefore(rTd, rowResult.cells[rowResult.cells.length-1]);

    lotElements.push({ aInput: aIn, bInput: bIn, cInput: cIn, resultCell: rTd });
  }
  recalcTotals();
}

// distribute totalC across current lots (equal share, remainder to last)
function distributeC(){
  const n = Number(numLots.value || 1);
  const stdA = Number(stdQty.value || 0);
  const tC = Number(totalC.value || 0);
  buildLots(n);
  if(n <= 0) return;
  const per = Math.floor((tC / n) * 1000) / 1000;
  let distributed = Array(n).fill(per);
  const sumDistributed = distributed.reduce((s,v)=>s+v,0);
  let remainder = Number((tC - sumDistributed).toFixed(6));
  distributed[n-1] = Number((distributed[n-1] + remainder).toFixed(3));
  lotElements.forEach((lot, idx) => {
    lot.aInput.value = fmt3(stdA);
    lot.cInput.value = fmt3(distributed[idx]);
    lot.bInput.value = '';
    lot.resultCell.textContent = '-';
  });
  recalcTotals();
}

// recalc totals and per-lot results
function recalcTotals(){
  let sumA=0,sumB=0,sumC=0,sumResult=0;
  lotElements.forEach(lot=>{
    const a = Number(lot.aInput.value || 0);
    const braw = (lot.bInput.value||'').toString();
    const b = (braw === '' ? NaN : Number(braw));
    const c = Number(lot.cInput.value || 0);
    sumA += a;
    if (!isNaN(b)) sumB += b;
    sumC += c;
    if (braw === '' || isNaN(b)) lot.resultCell.textContent = '-';
    else {
      const res = a + c - b;
      lot.resultCell.textContent = fmt3(res);
      sumResult += Number((Math.round((res + Number.EPSILON)*1000)/1000).toFixed(3));
    }
  });
  totalAEl.textContent = fmt3(sumA);
  totalBEl.textContent = fmt3(sumB);
  totalCEl.textContent = fmt3(sumC);
  totalResultEl.textContent = fmt3(sumResult);
}

function onLotInputChange(){ recalcTotals(); }

// Sync startup/menu fields
function syncStartupToMenu(){
  if (startupStdQty.value !== '') stdQty.value = startupStdQty.value;
  if (startupNumLots.value) numLots.value = startupNumLots.value;
  if (startupTotalC.value !== '') totalC.value = startupTotalC.value;
}
function syncMenuToStartup(){
  if (stdQty.value !== '') startupStdQty.value = stdQty.value;
  if (numLots.value) startupNumLots.value = numLots.value;
  if (totalC.value !== '') startupTotalC.value = totalC.value;
}
function closeStartupCurtain(){
  const panel = document.getElementById('startupPanel');
  panel.classList.add('curtain-up');
  setTimeout(()=> { startupOverlay.style.display = 'none'; }, 520);
}
function showCalculator(which){
  if (which === 'formula') {
    formulaCalculator.classList.remove('hidden');
    acbCalculator.classList.add('hidden');
    menuFormula.classList.add('active');
    menuAcb.classList.remove('active');
  } else {
    formulaCalculator.classList.add('hidden');
    acbCalculator.classList.remove('hidden');
    menuFormula.classList.remove('active');
    menuAcb.classList.add('active');
  }
}

// initial wiring
menuFormula.addEventListener('click', ()=> showCalculator('formula'));
menuAcb.addEventListener('click', ()=> showCalculator('acb'));

startupDistribute.addEventListener('click', ()=>{
  syncStartupToMenu();
  distributeC();
  closeStartupCurtain();
  showCalculator('acb');
});
distributeBtn.addEventListener('click', ()=>{
  syncMenuToStartup();
  distributeC();
  showCalculator('acb');
});
startupStdQty.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ syncStartupToMenu(); distributeC(); closeStartupCurtain(); showCalculator('acb'); }
});
stdQty.addEventListener('input', ()=> { startupStdQty.value = stdQty.value; });
numLots.addEventListener('change', ()=> { startupNumLots.value = numLots.value; });
totalC.addEventListener('input', ()=> { startupTotalC.value = totalC.value; });

resetAcb.addEventListener('click', ()=>{
  if(!confirm('Reset A+C-B calculator? This will clear all lots and values.')) return;
  clearLotColumns();
  totalAEl.textContent = '-';
  totalBEl.textContent = '0.000';
  totalCEl.textContent = '0.000';
  totalResultEl.textContent = '0.000';
});

// attach F1/F2/F3 to formula buttons (basic placeholder behaviour preserved)
document.getElementById('calcF1').addEventListener('click', ()=> alert('F1 calculation ‚Äî implement as needed'));
document.getElementById('calcF2').addEventListener('click', ()=> alert('F2 calculation ‚Äî implement as needed'));
document.getElementById('calcF3').addEventListener('click', ()=> alert('F3 calculation ‚Äî implement as needed'));

// On first load, show startup overlay
window.addEventListener('DOMContentLoaded', ()=> {
  // populate startup fields with defaults if present
  startupStdQty.value = stdQty.value || '';
  startupNumLots.value = numLots.value || '1';
  startupTotalC.value = totalC.value || '';
});
</script>

<!-- ========= Small usage notes & token instructions ========= -->
<script>
/*
  IMPORTANT:
  - I removed the hard-coded GitHub token from the file for safety.
  - To enable GitHub-backed storage, set the token at runtime (in console or a secure hosting env):
      window.GITHUB_TOKEN = 'ghp_xxx';  // then reload page
  - If token is not present, the chat will use localStorage as a fallback for testing.
  - Files used during this merge: index.html (chat logic & ACB functions) and index-1.html (calculator UI/logic). Ó®Å5Ó®Ç Ó®Å6Ó®Ç
*/
</script>

</body>
</html>