<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NIR8 Calculators</title>
<style>
  :root { --bg1:#4facfe; --bg2:#00f2fe; --menu-bg:rgba(0,0,0,.85); --accent:#28a745; }
  *{box-sizing:border-box}
  body{font-family:Poppins,system-ui,Arial,sans-serif;margin:0;background:linear-gradient(to right,var(--bg1),var(--bg2));min-height:100vh}
  .menu-bar{position:fixed;top:0;left:0;right:0;background:var(--menu-bg);color:#fff;z-index:1000;padding:10px 12px}
  .menu-container{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:12px}
  .menu-left{display:flex;gap:8px;align-items:center}
  .menu-item{padding:6px 10px;cursor:pointer;color:#fff}
  .menu-item.active{background:#19692f;border-radius:6px}
  .menu-controls{margin-left:auto;display:flex;gap:10px;align-items:center}
  label{display:block;font-size:12px;color:#ddd;margin-bottom:4px}
  input[type=number],select,button{font-size:14px}
  input[type=number],select{padding:8px;border-radius:6px;border:1px solid #ddd;background:#fff}
  button{padding:8px 12px;border-radius:6px;border:none;cursor:pointer;background:var(--accent);color:#fff}
  button.secondary{background:#007bff}
  .container{padding:110px 16px 80px;max-width:1100px;margin:0 auto}
  .calculator{background:#fff;border-radius:10px;padding:16px;margin-bottom:18px;box-shadow:0 6px 18px rgba(0,0,0,.12)}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #ddd;padding:8px;text-align:center}
  .acb-input{width:96px;padding:6px}
  .hidden{display:none!important}
  #startupOverlay{position:fixed;inset:0;background:linear-gradient(to right,var(--bg1),var(--bg2));z-index:2000;display:flex;align-items:center;justify-content:center}
  .startup-panel{width:100%;max-width:920px;background:#fff;padding:22px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.2)}
  .curtain-up{transform:translateY(-120%);transition:transform .52s cubic-bezier(.2,.9,.3,1)}
  footer{position:fixed;left:0;right:0;bottom:0;background:var(--menu-bg);color:#fff;text-align:center;padding:8px;font-size:14px}
  @media (max-width:820px){ .menu-container{flex-wrap:wrap} .menu-controls{width:100%;justify-content:center} .startup-panel{padding:16px} .acb-input{width:80px} }
</style>
</head>
<body>

<!-- Top menu -->
<div class="menu-bar" role="navigation" aria-label="Top menu">
  <div class="menu-container">
    <div class="menu-left">
      <div class="menu-item active" id="menuFormula" data-target="formula">Formula Calculator</div>
      <div class="menu-item" id="menuAcb" data-target="acb">(A + C) - B Calculator</div>
    </div>

    <div class="menu-controls" role="region" aria-label="Standard controls">
      <div>
        <label for="stdQty">Std Qty (A) — per lot</label>
        <input id="stdQty" type="number" step="0.001" min="0" placeholder="e.g. 417.000" aria-label="Std Qty per lot">
      </div>

      <div>
        <label for="numLots">Lots</label>
        <select id="numLots" aria-label="Number of lots">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
        </select>
      </div>

      <div>
        <label for="totalC">Total Std C (kg)</label>
        <input id="totalC" type="number" step="0.001" min="0" placeholder="Total C">
      </div>

      <div style="display:flex;align-items:flex-end">
        <button id="distributeBtn" title="Distribute C equally">Distribute C</button>
      </div>
    </div>
  </div>
</div>

<!-- Startup overlay (blocks until initial setup) -->
<div id="startupOverlay" role="dialog" aria-modal="true">
  <div class="startup-panel" id="startupPanel">
    <h2 style="margin:0 0 8px 0">Setup</h2>
    <p style="margin:0 0 12px 0;color:#333">Enter <strong>Std Qty (A)</strong> (this is <em>per lot</em>), choose number of lots (1–5) and enter <strong>Total Std C</strong>. Click <strong>Distribute C</strong> or press Enter in the Std Qty field to continue.</p>

    <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:160px">
        <label for="startupStdQty">Std Qty (A) — per lot</label>
        <input id="startupStdQty" type="number" step="0.001" min="0" placeholder="e.g. 417.000">
      </div>

      <div style="min-width:100px">
        <label for="startupNumLots">Lots</label>
        <select id="startupNumLots">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
        </select>
      </div>

      <div style="flex:1;min-width:160px">
        <label for="startupTotalC">Total Std C (kg)</label>
        <input id="startupTotalC" type="number" step="0.001" min="0" placeholder="e.g. 337.500">
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;margin-top:16px">
      <button id="startupDistribute">Distribute C</button>
    </div>

    <p style="margin-top:12px;color:#666;font-size:13px">You can change these values any time in the top menu — all fields remain editable.</p>
  </div>
</div>

<main class="container">

  <!-- Formula calculator (kept simple) -->
  <section id="formulaCalculator" class="calculator" role="region" aria-label="Formula calculator">
    <h3 style="margin-top:0">Formula Calculator</h3>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:150px">
        <label for="Q">Quantity (Q)</label>
        <input id="Q" type="number" step="0.001" placeholder="Enter Q">
      </div>
      <div style="min-width:150px">
        <label for="water">Water (W)</label>
        <input id="water" type="number" step="0.01" placeholder="W (%)">
      </div>
      <div style="min-width:150px">
        <label for="assay">Assay (A)</label>
        <input id="assay" type="number" step="0.01" placeholder="A (%)">
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <button onclick="alert('F1 placeholder')">Calculate F1</button>
      <button onclick="alert('F2 placeholder')">Calculate F2</button>
      <button onclick="alert('F3 placeholder')">Calculate F3</button>
    </div>
  </section>

  <!-- A + C - B calculator -->
  <section id="acbCalculator" class="calculator hidden" role="region" aria-label="A C B calculator">
    <h3 style="margin-top:0">(A + C) - B Calculator</h3>

    <div style="overflow:auto">
      <table id="acbTable" aria-describedby="acbDesc">
        <caption id="acbDesc" class="hidden">Assay-based (A + C) - B calculations</caption>
        <thead>
          <tr id="acbHeaderRow">
            <th>Field</th>
            <!-- lot headers are inserted dynamically here -->
            <th>Total (kg)</th>
          </tr>
        </thead>
        <tbody>
          <tr id="rowA"><td>A per lot (editable)</td><!-- A cells --> <td id="totalA">-</td></tr>
          <tr id="rowB"><td>Issued Qty B</td><!-- B cells --> <td id="totalB">0.000</td></tr>
          <tr id="rowC"><td>C per lot (distributed, editable)</td><!-- C cells --> <td id="totalCDisplay">0.000</td></tr>
          <tr id="rowResult"><td>(A + C) - B</td><!-- result cells --> <td id="totalResult">0.000</td></tr>
        </tbody>
      </table>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="resetAcb" style="background:#ff6b6b">Reset</button>
      <button id="printAcb" class="secondary">Print</button>
    </div>
  </section>

  <!-- Calculation steps (not used heavily here) -->
  <div id="calculationSteps" class="hidden"></div>

</main>

<footer>Results are reliable but always double-check. NIR8 Tools</footer>

<script>
/*
  Full functional behavior:
  - Startup overlay blocks until initial Distribute (or Enter in startupStdQty)
  - Top menu controls always editable
  - Distribute C => build lot columns, set A per-lot from StdQty (editable), distribute C equally, last lot absorbs rounding diff
  - B inputs per lot editable, per-lot result = A + C - B; if B empty, show '-'
  - Totals update for visible lots only
  - User can change values later and recalc; pressing Distribute again redistributes C based on current Total Std C and lot count
*/

// small safe formatter to 3 decimals
function fmt3(v){ 
  const n = Number(v);
  if (!isFinite(n)) return '0.000';
  return (Math.round((n + Number.EPSILON) * 1000) / 1000).toFixed(3);
}

// DOM refs
const startupOverlay = document.getElementById('startupOverlay');
const startupStdQty = document.getElementById('startupStdQty');
const startupNumLots = document.getElementById('startupNumLots');
const startupTotalC = document.getElementById('startupTotalC');
const startupDistribute = document.getElementById('startupDistribute');

const stdQty = document.getElementById('stdQty');
const numLots = document.getElementById('numLots');
const totalC = document.getElementById('totalC');
const distributeBtn = document.getElementById('distributeBtn');

const menuFormula = document.getElementById('menuFormula');
const menuAcb = document.getElementById('menuAcb');
const formulaCalculator = document.getElementById('formulaCalculator');
const acbCalculator = document.getElementById('acbCalculator');

const acbHeaderRow = document.getElementById('acbHeaderRow');
const rowA = document.getElementById('rowA');
const rowB = document.getElementById('rowB');
const rowC = document.getElementById('rowC');
const rowResult = document.getElementById('rowResult');

const totalAEl = document.getElementById('totalA');
const totalBEl = document.getElementById('totalB');
const totalCEl = document.getElementById('totalCDisplay');
const totalResultEl = document.getElementById('totalResult');

const resetAcb = document.getElementById('resetAcb');
const printAcb = document.getElementById('printAcb');

let lotElements = []; // {aInput, bInput, cInput, resultCell}

// helper: clear existing lot columns
function clearLotColumns(){
  // remove header cells except first and last
  while(acbHeaderRow.cells.length > 2) acbHeaderRow.deleteCell(1);
  // remove data cells for each row except first and last in each row
  [rowA, rowB, rowC, rowResult].forEach(r => {
    while(r.cells.length > 2) r.deleteCell(1);
  });
  lotElements = [];
}

// build columns for n lots
function buildLots(n){
  clearLotColumns();
  for(let i=0;i<n;i++){
    // header
    const th = document.createElement('th');
    th.textContent = 'Lot-' + (i+1);
    acbHeaderRow.insertBefore(th, acbHeaderRow.cells[acbHeaderRow.cells.length-1]);

    // A cell
    const aTd = document.createElement('td');
    const aIn = document.createElement('input');
    aIn.type = 'number'; aIn.step = '0.001'; aIn.className = 'acb-input'; aIn.placeholder = 'A';
    aIn.addEventListener('input', onLotInputChange);
    aTd.appendChild(aIn);
    rowA.insertBefore(aTd, rowA.cells[rowA.cells.length-1]);

    // B cell
    const bTd = document.createElement('td');
    const bIn = document.createElement('input');
    bIn.type = 'number'; bIn.step = '0.001'; bIn.className = 'acb-input'; bIn.placeholder = 'B';
    bIn.addEventListener('input', onLotInputChange);
    bTd.appendChild(bIn);
    rowB.insertBefore(bTd, rowB.cells[rowB.cells.length-1]);

    // C cell
    const cTd = document.createElement('td');
    const cIn = document.createElement('input');
    cIn.type = 'number'; cIn.step = '0.001'; cIn.className = 'acb-input'; cIn.placeholder = 'C';
    cIn.addEventListener('input', onLotInputChange);
    cTd.appendChild(cIn);
    rowC.insertBefore(cTd, rowC.cells[rowC.cells.length-1]);

    // result cell
    const rTd = document.createElement('td');
    rTd.textContent = '-';
    rowResult.insertBefore(rTd, rowResult.cells[rowResult.cells.length-1]);

    lotElements.push({ aInput: aIn, bInput: bIn, cInput: cIn, resultCell: rTd });
  }
  recalcTotals(); // init totals
}

// distribute totalC across current lots
function distributeC(){
  const n = Number(numLots.value || 1);
  const stdA = Number(stdQty.value || 0);
  const tC = Number(totalC.value || 0);

  // build columns
  buildLots(n);

  // calculate equal share truncated to 3 decimals and put remainder to last lot
  if(n <= 0) return;
  // compute share as truncated toward floor to 3 decimals to keep earlier equal
  const per = Math.floor((tC / n) * 1000) / 1000;
  let distributed = Array(n).fill(per);
  // adjust last lot
  const sumDistributed = distributed.reduce((s,v)=>s+v,0);
  let remainder = Number((tC - sumDistributed).toFixed(6));
  // add remainder to last lot (could be + or -)
  distributed[n-1] = Number((distributed[n-1] + remainder).toFixed(3));

  // fill A and C, reset B and results
  lotElements.forEach((lot, idx) => {
    lot.aInput.value = fmt3(stdA);
    lot.cInput.value = fmt3(distributed[idx]);
    lot.bInput.value = ''; // reset issued
    lot.resultCell.textContent = '-';
  });

  recalcTotals();
}

// recalc on any lot input change
function onLotInputChange(){
  recalcTotals();
}

// recalc totals and per-lot results
function recalcTotals(){
  let sumA = 0, sumB = 0, sumC = 0, sumResult = 0;
  lotElements.forEach(lot => {
    const a = Number(lot.aInput.value || 0);
    const braw = lot.bInput.value;
    const b = (braw === '' ? NaN : Number(braw));
    const c = Number(lot.cInput.value || 0);

    sumA += a;
    if (!isNaN(b)) sumB += b;
    sumC += c;

    if (braw === '' || isNaN(b)) {
      lot.resultCell.textContent = '-';
    } else {
      const res = a + c - b;
      lot.resultCell.textContent = fmt3(res);
      sumResult += Number((Math.round((res + Number.EPSILON)*1000)/1000).toFixed(3));
    }
  });

  totalAEl.textContent = fmt3(sumA);
  totalBEl.textContent = fmt3(sumB);
  totalCEl.textContent = fmt3(sumC);
  totalResultEl.textContent = fmt3(sumResult);
}

// sync startup overlay values to top menu
function syncStartupToMenu(){
  if (startupStdQty.value !== '') stdQty.value = startupStdQty.value;
  if (startupNumLots.value) numLots.value = startupNumLots.value;
  if (startupTotalC.value !== '') totalC.value = startupTotalC.value;
}

// sync menu to startup (keeps overlay and menu in sync if user edits menu before closing overlay)
function syncMenuToStartup(){
  if (stdQty.value !== '') startupStdQty.value = stdQty.value;
  if (numLots.value) startupNumLots.value = numLots.value;
  if (totalC.value !== '') startupTotalC.value = totalC.value;
}

// close startup overlay with curtain animation
function closeStartupCurtain(){
  const panel = document.getElementById('startupPanel');
  panel.classList.add('curtain-up');
  // remove overlay after animation
  setTimeout(() => {
    startupOverlay.style.display = 'none';
  }, 520);
}

// show appropriate calculator
function showCalculator(which){
  if (which === 'formula') {
    formulaCalculator.classList.remove('hidden');
    acbCalculator.classList.add('hidden');
    menuFormula.classList.add('active');
    menuAcb.classList.remove('active');
  } else {
    formulaCalculator.classList.add('hidden');
    acbCalculator.classList.remove('hidden');
    menuFormula.classList.remove('active');
    menuAcb.classList.add('active');
  }
}

// initial event wiring
menuFormula.addEventListener('click', ()=> showCalculator('formula'));
menuAcb.addEventListener('click', ()=> showCalculator('acb'));

// Distribute handlers (startup and top menu)
startupDistribute.addEventListener('click', ()=>{
  syncStartupToMenu();
  distributeC();
  closeStartupCurtain();
  showCalculator('acb');
});

distributeBtn.addEventListener('click', ()=>{
  syncMenuToStartup();
  distributeC();
  showCalculator('acb');
});

// allow pressing Enter in startupStdQty to proceed (copy values and distribute)
startupStdQty.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){ syncStartupToMenu(); distributeC(); closeStartupCurtain(); showCalculator('acb'); }
});

// keep top menu and startup values in sync when user edits top menu before closing overlay
stdQty.addEventListener('input', ()=> { startupStdQty.value = stdQty.value; });
numLots.addEventListener('change', ()=> { startupNumLots.value = numLots.value; });
totalC.addEventListener('input', ()=> { startupTotalC.value = totalC.value; });

// reset behavior
resetAcb.addEventListener('click', ()=>{
  if(!confirm('Reset A+C-B calculator? This will clear all lots and values.')) return;
  // clear top controls but leave overlay hidden (as requested)
  stdQty.value = '';
  totalC.value = '';
  numLots.value = '1';
  clearLotColumns();
  recalcTotals();
});

// print
printAcb.addEventListener('click', ()=> window.print());

// initialize: build 1 lot but keep overlay shown until user acts
window.addEventListener('load', ()=>{
  // prefill menu from startup if available
  if(startupStdQty.value) stdQty.value = startupStdQty.value;
  if(startupNumLots.value) numLots.value = startupNumLots.value;
  if(startupTotalC.value) totalC.value = startupTotalC.value;
  buildLots(Number(numLots.value || 1));
  showCalculator('formula'); // default
});

// keep A inputs updated when top Std Qty is changed: auto-apply to visible lots (but editable)
stdQty.addEventListener('input', ()=>{
  const val = stdQty.value;
  lotElements.forEach(lot => {
    // only change the value if the user hasn't edited this A (but per spec A is editable always).
    // We will set A to stdQty (allowing overwrite by user later).
    lot.aInput.value = (val === '' ? '' : fmt3(Number(val)));
  });
  recalcTotals();
});

// if user changes number of lots in top menu, rebuild columns preserving existing where possible
numLots.addEventListener('change', ()=>{
  const n = Number(numLots.value || 1);
  // If lotElements exists, try to preserve first min(old,n) values
  const old = lotElements.slice();
  buildLots(n);
  // try to copy older values for overlapping indices
  for(let i=0;i<Math.min(old.length, lotElements.length); i++){
    lotElements[i].aInput.value = old[i].aInput.value;
    lotElements[i].bInput.value = old[i].bInput.value;
    lotElements[i].cInput.value = old[i].cInput.value;
  }
  recalcTotals();
});

// if user edits totalC manually and clicks distribute, it will redistribute
totalC.addEventListener('change', ()=> {
  // user must press Distribute to apply; no auto apply on change (keeps control)
});

// ensure editing any lot input triggers recalc
function recalc(){ recalcTotals(); }

// End of script
</script>

</body>
</html>
